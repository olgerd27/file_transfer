/*
 * prg_clnt.c: the client program to initiate the remote file transfers
 *
 * Build this program:
 * gcc prg_clnt.c ../rpcgen/fltr_clnt.c ../rpcgen/fltr_xdr.o -I/usr/include/tirpc -o prg_clnt -lnsl -ltirpc
 */

#include <stdio.h>
#include "../rpcgen/fltr.h" /* generated by rpcgen */

/*
 * Read the binary file to get its content for transfering
 */
void read_file(const char *filename, file *fobj)
{
  u_int *pf_len = &fobj->cont.t_flcont_len; // pointer to file length, for quick access
  char **pf_data = &fobj->cont.t_flcont_val; // pointer to file data, for quick access

  // For test purposes. TODO: DELETE when will not be needed
  // *pf_len = 6;
  // *pf_data = (char*)malloc(*pf_len);
  // strcpy(*pf_data, "Hello");

  // Open the file
  FILE *hfile = fopen(filename, "rb");
  if (hfile == NULL) {
    fprintf(stderr, "!--Error 2: cannot open file '%s' for reading\n", filename);
    exit(2);
  }

  // obtain file size
  fseek(hfile, 0, SEEK_END);
  *pf_len = ftell(hfile);
  rewind(hfile);

  // allocate memory to contain the whole file
  *pf_data = (char*)malloc(*pf_len);
  if (*pf_data == NULL) {
    fprintf(stderr, "!--Error 3: memory allocation error, size=%ld\n", *pf_len);
    exit(3);
  }

  // copy the file into the buffer
  size_t res_read = fread(*pf_data, 1, *pf_len, hfile);
  if (res_read != *pf_len) {
    fprintf(stderr, "!--Error 4: file '%s' reading error\n", filename);
    exit(4);
  }

  fclose(hfile);
}

int main(int argc, char *argv[])
{
  CLIENT *clnt; // client object
  char *server; // server name
  char *filename_src; // a client's source file to be transferred to a server
  errinf *res_serv; // result returned from a server
  file file_obj; // file object

  if (argc != 4) {
    fprintf(stderr, "!--Error 1: Usage: %s [host] [file_source] [file_dest]\n", argv[0]);
    return 1;
  }

  // Get the argument values  
  server = argv[1];
  filename_src = argv[2];
  file_obj.name = argv[3];

  // Get the file content
  read_file(filename_src, &file_obj);

  /*
   * Create client "handle" used for calling FLTRPROG 
   * on the server designated on the command line.
   */

  clnt = clnt_create(server, FLTRPROG, FLTRVERS, "tcp");

  if (clnt == (CLIENT *)NULL) {
    // Print an error indication why a client handle could not be created.
    // Used when clnt_create() call fails.
    clnt_pcreateerror(server);
    return 5;
  }

  res_serv = upload_file_1(&file_obj, clnt);

  if (res_serv == (errinf *)NULL) {
    // Print a message to standard error indicating why an RPC call failed.
    // Used after clnt_call(), that is called here by upload_file_1().
    clnt_perror(clnt, server);
    return 6;
  }

  /* Okay, we successfully called the remote procedure. */

  if (res_serv->num != 0) {
    // Remote system error. Print error message and die.
    printf("!---Server error %d: %s\n", res_serv->num, res_serv->errinf_u.msg);
    return res_serv->num;
  }

  clnt_destroy(clnt);
  free(file_obj.cont.t_flcont_val);

  return 0;
}

